# ==============================================================================
# Stage 1: Build（只做编译）
# ==============================================================================
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src

COPY ["nuget.config", "./"]

# 1. 复制解决方案和项目文件（利用缓存机制）
# --- JobSamples 项目 ---
# 1. 先 build 插件（输出到 /app/Plugins/JobSamples）    
COPY ["JobSamples/JobSamples.csproj", "JobSamples/"]
RUN dotnet restore JobSamples/JobSamples.csproj --runtime linux-x64
COPY ["JobSamples/", "JobSamples/"]
# 发布到独立目录 /app/Plugins/JobSamples
RUN dotnet build JobSamples/JobSamples.csproj \
    -c Release -o /app/Plugins/JobSamples \
    -r linux-x64 \
    -p:PublishReadyToRun=true \
    -p:PublishSingleFile=false \
    -p:SelfContained=false 


# --- JobAgent.Console 项目 ---
# 2. 再 publish 宿主（追加到 /app，不会清掉 Plugins）    
COPY ["JobAgent.sln", "."]
COPY ["JobAgent.Console/JobAgent.Console.csproj", "JobAgent.Console/"]
# 若有其他项目，继续 COPY 对应的 csproj
# 2. 还原依赖包（指定目标平台，确保linux可用）
RUN dotnet restore JobAgent.Console/JobAgent.Console.csproj --runtime linux-x64
COPY ["JobAgent.Console/", "JobAgent.Console/"]
# 4. 编译并发布（发布为 linux-x64，非自包含）
RUN dotnet publish JobAgent.Console/JobAgent.Console.csproj \
    -c Release -o /app \
    -r linux-x64 \
    -p:PublishReadyToRun=true \
    -p:PublishSingleFile=true \
    -p:SelfContained=false 

# 在 build 容器里建好空目录并赋权
RUN mkdir -p /app/states /app/logs && \
    chmod -R 755 /app/states /app/logs && \
    chown -R 65532:65532 /app/states /app/logs

# ==============================================================================
# Stage 2: Runtime（chiseled —— 无 sh、无 chmod）
# ==============================================================================
## 8.0-jammy-chiseled 基础镜像（更小、更安全）
FROM mcr.microsoft.com/dotnet/runtime:8.0-jammy-chiseled 
## 这是一个比较全的调试版 runtime 镜像，带有 shell 和常用工具，方便排查问题
#FROM mcr.microsoft.com/dotnet/sdk:8.0-jammy
WORKDIR /app
COPY --from=build --chown=65532:65532 /app .

USER 65532
ENTRYPOINT ["./JobAgent"]
