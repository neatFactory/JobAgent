name: Build JobAgent

on:
  push:
    branches:
      - "main"
      #- "**"
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.os }} / ${{ matrix.runtime }}
    runs-on: ${{ matrix.os }}
    outputs:
      version: ${{ steps.set_version.outputs.version }} # ðŸš€ expouse version
      phase: ${{steps.set_version.outputs.phase }} # ðŸš€ expouse phase
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            runtime: linux-x64
          - os: ubuntu-latest
            runtime: linux-arm64
          - os: windows-latest
            runtime: win-x64
          - os: macos-latest
            runtime: osx-x64
    steps:
      - name: Set Version
        id: set_version
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_VERSION="0.0.1"  # é»˜è®¤åŸºç¡€ç‰ˆæœ¬ï¼Œå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹
          REF="${GITHUB_REF}"
          BRANCH_NAME="${GITHUB_REF##*/}"
          DATE_SUFFIX=$(date +'%y%m%d%H')  # å–å¾—æ—¶é—´ç‰ˆæœ¬25110315
          COUNTER=$(date +'%H%M')

          # Tagç‰ˆæœ¬ æ›¿ä»£ BASE_VERSION
          if [[ "$REF" == refs/tags/* ]]; then
            TAG_NAME="${REF#refs/tags/}"
            TAG_VERSION="${TAG_NAME#[vV]}"  # åŽ»æŽ‰ v/V å‰ç¼€
            BASE_VERSION="$TAG_VERSION"
            echo "Detected tag: $TAG_NAME -> BASE_VERSION=$BASE_VERSION"
          fi

          # æ ¹æ®åˆ†æ”¯ç”Ÿæˆç‰ˆæœ¬å·
          case "$BRANCH_NAME" in
            main)
              VERSION="${BASE_VERSION}"
              PHASE="Release"
              ;;
            rc/*)
              VERSION="${BASE_VERSION}-rc${DATE_SUFFIX}"
              PHASE="RC"
              ;;
            beta/*)
              VERSION="${BASE_VERSION}-beta${DATE_SUFFIX}"
              PHASE="Beta"
              ;;
            dev/*|*)
              VERSION="${BASE_VERSION}-dev${DATE_SUFFIX}"
              PHASE="Alpha"
              ;;
          esac

          # è¾“å‡ºåˆ° workflow è¾“å‡ºå˜é‡
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "phase=$PHASE" >> $GITHUB_OUTPUT

      - name: Log Version
        run: |
          echo "Current Version: ${{ steps.set_version.outputs.version }} "

      - uses: actions/checkout@v3
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"
      - run: dotnet restore JobAgent.sln
      - run: dotnet build JobSamples/JobSamples.csproj -c Release -r ${{ matrix.runtime }} --self-contained false -o ./publish/JobSamples
      - run: dotnet publish JobAgent.Console/JobAgent.Console.csproj -c Release -r ${{ matrix.runtime }} --self-contained true -p:PublishSingleFile=true -o ./publish/JobAgent
